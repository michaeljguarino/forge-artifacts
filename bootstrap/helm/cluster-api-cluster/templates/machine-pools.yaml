{{ $currentScope := . }}
{{- range $key, $value := .Values.workers }}
{{- if eq $key $.Values.provider }}
{{- range $name, $values := $value }}
{{- with $currentScope }}
apiVersion: cluster.x-k8s.io/v1beta1
kind: MachinePool
metadata:
  name: {{ $name }}
spec:
  clusterName: {{ $.Values.cluster.name }}
  {{ if $values.replicas }}
  replicas: {{ $values.replicas }}
  {{ else }}
  replicas: 0
  {{ end }}
  template:
    spec:
      {{ if or (eq .Values.provider "google") (eq .Values.provider "azure") (eq .Values.provider "kind") }}
      version: {{ $values.kubernetesVersion | default $.Values.cluster.kubernetesVersion }}
      {{ end }}
      # failureDomain: # TODO: figure out if we should set this value here. Must match a key in the FailureDomains map stored on the cluster object.
      clusterName: {{ $.Values.cluster.name }}
      bootstrap:
        {{ if or (eq .Values.provider "google") (eq .Values.provider "azure") (eq .Values.provider "aws") }}
        dataSecretName: ""
        {{ end }}
        {{ include "workers.configref" . | nindent 8}}
      infrastructureRef:
        name: {{ $name }}
        apiVersion: {{ include "workers.infrastructure.apiVersion" . }}
        kind: {{ include "workers.infrastructure.kind" . }}
{{- end }}
---
{{- end }}
{{ end }}
{{ end }}
