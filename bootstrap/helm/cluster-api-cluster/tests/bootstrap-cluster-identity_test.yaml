suite: test azure cluster identity
templates:
  - azure/bootstrap-cluster-identity.yaml
tests:
  - it: should be created if bootstrapMode is true
    set:
      provider: azure
      type: managed
      cluster.azure.clusterIdentity.bootstrapMode: true
    asserts:
      - hasDocuments:
          count: 4
      - isKind:
          of: AzureClusterIdentity
        documentIndex: 0
      - matchRegex:
          path: metadata.name
          pattern: -azure-bootstrap-identity$
        documentIndex: 0
  - it: should not be created if bootstrapMode is false
    set:
      provider: azure
      type: managed
      cluster.azure.clusterIdentity.bootstrapMode: false
    asserts:
      - hasDocuments:
          count: 0
      # - containsDocument:
      #     kind: AzureIdentity
      #     apiVersion: aadpodidentity.k8s.io/v1
      #   not: true
      # - containsDocument:
      #     kind: AzureIdentityBinding
      #     apiVersion: aadpodidentity.k8s.io/v1
      #   not: true
      # - isKind:
      #     of: AzureClusterIdentity
      # - matchRegex:
      #     path: metadata.name
      #     pattern: $-azure-bootstrap-identity
      # - equal:
      #     path: spec.template.spec.containers[0].image
      #     value: nginx:latest
